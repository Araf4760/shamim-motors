<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>মেসার্স শামীম মটরস - Sell Form</title>
  <style>
    body { background: #0f0f3d; color: white; font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .container { max-width: 900px; margin: 20px auto; background: #12123d; padding: 20px; border-radius: 10px; }
    .header-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 20px; }
    .logo-box { border: 2px solid orange; padding: 10px; font-weight: bold; margin-bottom: 10px; }
    h2 { font-size: 24px; }
    .search-box { display: flex; align-items: center; gap: 5px; margin-top: 10px; }
    .form-title { background: green; padding: 5px 10px; border-radius: 5px; }
    .search-label { background: orange; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
    #searchInput { padding: 5px; }
    .form-row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    .form-group { flex: 1; min-width: 150px; display: flex; flex-direction: column; }
    label { margin-bottom: 5px; color: #ffc107; }
    input { padding: 8px; border: none; border-radius: 5px; }
    .section-title { background: #1a1a4d; padding: 8px; border-radius: 5px; margin: 15px 0 10px 0; text-align: center; font-weight: bold; }
    .buttons { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; justify-content: center; }
    button { background: #1a1a4d; color: orange; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
    button:hover { background: #29296b; }
  </style>
</head>
<body>
<div class="container">
  <div class="header-row">
    <div class="logo-box">লোগো</div>
    <h2>মেসার্স শামীম মটরস</h2>
    <div class="search-box">
      <div class="form-title">Sell Form</div>
      <div class="search-label" onclick="searchEntry()">সার্চ</div>
      <input type="text" id="searchInput">
    </div>
  </div>

  <form id="entryForm">
    <div class="form-row">
      <div class="form-group"><label>ক্রমিক নং:</label><input type="text" name="serial"></div>
      <div class="form-group"><label>তারিখ:</label><input type="date" name="date"></div>
    </div>

    <div class="form-row">
      <div class="form-group"><label>নাম:</label><input type="text" name="name"></div>
      <div class="form-group"><label>পিতার নাম:</label><input type="text" name="father"></div>
    </div>

    <div class="form-row">
      <div class="form-group"><label>এন.আই.ডি নং:</label><input type="text" name="nid"></div>
      <div class="form-group"><label>জন্ম তারিখ:</label><input type="date" name="dob"></div>
      <div class="form-group"><label>মোবাইল নম্বর:</label><input type="text" name="mobile"></div>
    </div>

    <div class="form-row">
      <div class="form-group"><label>ঠিকানা:</label><input type="text" name="address"></div>
    </div>

    <div class="section-title">বিবরণ</div>

    <div class="form-row">
      <div class="form-group"><label>গাড়ির ধরন:</label><input type="text" name="vehicle_type"></div>
      <div class="form-group"><label>নাম্বার প্লেট:</label><input type="text" name="number_plate"></div>
      <div class="form-group"><label>ইঞ্জিন নম্বর:</label><input type="text" name="engine"></div>
    </div>

    <div class="form-row">
      <div class="form-group"><label>চেসিস নম্বর:</label><input type="text" name="chassis"></div>
      <div class="form-group"><label>মডেল:</label><input type="text" name="model"></div>
    </div>

    <div class="form-row">
      <div class="form-group"><label>সিসি:</label><input type="text" name="cc"></div>
      <div class="form-group"><label>কালার:</label><input type="text" name="color"></div>
    </div>

    <div class="section-title">ক্যাশ</div>

    <div class="form-row">
      <div class="form-group"><label>মোট টাকা:</label><input type="text" name="total"></div>
      <div class="form-group"><label>নগদ টাকা:</label><input type="text" name="cash"></div>
      <div class="form-group"><label>বাকি টাকা:</label><input type="text" name="due"></div>
    </div>

    <div class="buttons">
      <button type="submit">জমা</button>
      <button type="button" onclick="loadPreviousEntry()">পূর্বের তথ্য</button>
      <button type="button" onclick="loadNextEntry()">পরের তথ্য</button>
      <button type="button" onclick="deleteEntry()">ডিলিট</button>
      <button type="button" onclick="downloadPDF()">PDF</button>
      <button type="button" onclick="printEntry()">প্রিন্ট</button>
      <button type="button" onclick="exportData()">এক্সপোর্ট</button>
    </div>
  </form>
</div>

<script>
const apiURL = 'https://script.google.com/macros/s/AKfycbz23ZqI3IG7DtNnVbonVJnHteACXz3ns1a5AqpPWMEEZ_hZIsUR5OhTJAoajNkVjrO12w/exec';
let allEntries = [];
let currentIndex = -1;

function fetchAllEntries() {
  fetch(apiURL)
    .then(response => response.json())
    .then(data => {
      allEntries = data.entries;
    })
    .catch(error => {
      console.error('ডেটা আনতে সমস্যা হয়েছে ❌', error);
    });
}

document.getElementById('entryForm').addEventListener('submit', function(event) {
  event.preventDefault(); // রিলোড বন্ধ করি
  const form = event.target;
  const formData = new FormData(form);
  const formObject = {};
  formData.forEach((value, key) => {
    formObject[key] = value;
  });

  fetch(apiURL, {
    method: 'POST',
    body: JSON.stringify(formObject),
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      alert('✅ সফলভাবে জমা হয়েছে!');
      form.reset();
      fetchAllEntries(); // নতুন ডেটা রিফ্রেশ করবো
    } else {
      alert('❌ জমা হয়নি!');
    }
  })
  .catch(error => {
    console.error('জমাতে সমস্যা হয়েছে ❌', error);
    alert('❌ জমাতে সমস্যা হয়েছে!');
  });
});

function searchEntry() {
  const query = document.getElementById('searchInput').value.trim().toLowerCase();
  if (!query) {
    alert('সার্চ টেক্সট দিন!');
    return;
  }
  const foundIndex = allEntries.findIndex(entry =>
    Object.values(entry).some(val => val.toLowerCase().includes(query))
  );
  if (foundIndex !== -1) {
    currentIndex = foundIndex;
    fillForm(allEntries[currentIndex]);
    alert('✅ তথ্য পাওয়া গেছে!');
  } else {
    alert('❌ তথ্য খুঁজে পাওয়া যায়নি!');
  }
}

function fillForm(data) {
  Object.keys(data).forEach(key => {
    const field = document.querySelector(`[name="${key}"]`);
    if (field) field.value = data[key];
  });
}

function loadPreviousEntry() {
  if (currentIndex > 0) {
    currentIndex--;
    fillForm(allEntries[currentIndex]);
  } else {
    alert('❌ প্রথম এন্ট্রিতে আছেন!');
  }
}

function loadNextEntry() {
  if (currentIndex < allEntries.length - 1) {
    currentIndex++;
    fillForm(allEntries[currentIndex]);
  } else {
    alert('❌ শেষ এন্ট্রিতে আছেন!');
  }
}

function deleteEntry() {
  if (currentIndex === -1) {
    alert('⚠️ কোন তথ্য সিলেক্ট করা হয়নি!');
    return;
  }
  if (confirm('আপনি কি নিশ্চিত ডিলিট করতে চান? ⚠️')) {
    allEntries.splice(currentIndex, 1);
    alert('✅ তথ্য মুছে ফেলা হয়েছে লোকালি! (Google Sheet থেকে আলাদা ডিলিট করতে হবে)');
    document.getElementById("entryForm").reset();
  }
}

function downloadPDF() {
  const form = document.getElementById('entryForm');
  const formData = new FormData(form);
  let entry = {};
  for (let [key, value] of formData.entries()) {
    entry[key] = value;
  }
  const queryString = encodeURIComponent(JSON.stringify(entry));
  const printURL = `print-form.html?data=${queryString}`;
  const newWindow = window.open(printURL, '_blank');
  newWindow.onload = function() { newWindow.print(); };
}

function printEntry() {
  const form = document.getElementById('entryForm');
  const formData = new FormData(form);
  let entry = {};
  for (let [key, value] of formData.entries()) {
    entry[key] = value;
  }
  const queryString = encodeURIComponent(JSON.stringify(entry));
  const printURL = `print-form.html?data=${queryString}`;
  window.open(printURL, '_blank');
}

function exportData() {
  if (allEntries.length === 0) {
    alert('⚠️ কোন ডেটা নেই এক্সপোর্ট করার জন্য!');
    return;
  }
  const headers = Object.keys(allEntries[0]);
  const csvRows = [
    headers.join(','),
    ...allEntries.map(row => headers.map(field => `"${row[field] || ''}"`).join(','))
  ];
  const csvData = csvRows.join('\n');
  const blob = new Blob([csvData], { type: 'text/csv' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'entries.csv';
  link.click();
}

window.onload = fetchAllEntries;
</script>
<script>
    const totalInput = document.querySelector('input[name="total"]');
    const cashInput = document.querySelector('input[name="cash"]');
    const dueInput = document.querySelector('input[name="due"]');

    function calculateDue() {
      const total = parseFloat(totalInput.value) || 0;
      const cash = parseFloat(cashInput.value) || 0;
      const due = total - cash;
      dueInput.value = due >= 0 ? due : 0;
    }

    totalInput.addEventListener('input', calculateDue);
    cashInput.addEventListener('input', calculateDue);
  </script>

</body>
</html>
