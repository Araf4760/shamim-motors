<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>মেসার্স শামীম মটরস - Sell Form</title>
  <style>
    body { background: #0f0f3d; color: white; font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .container { max-width: 900px; margin: 20px auto; background: #12123d; padding: 20px; border-radius: 10px; }
    .header-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 20px; }
    .logo-box { border: 2px solid orange; padding: 10px; font-weight: bold; margin-bottom: 10px; }
    h2 { font-size: 24px; }
    .search-box { display: flex; align-items: center; gap: 5px; margin-top: 10px; }
    .form-title { background: green; padding: 5px 10px; border-radius: 5px; }
    .search-label { background: orange; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
    #searchInput { padding: 5px; }
    .form-row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    .form-group { flex: 1; min-width: 150px; display: flex; flex-direction: column; }
    label { margin-bottom: 5px; color: #ffc107; }
    input { padding: 8px; border: none; border-radius: 5px; }
    .section-title { background: #1a1a4d; padding: 8px; border-radius: 5px; margin: 15px 0 10px 0; text-align: center; font-weight: bold; }
    .buttons { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; justify-content: center; }
    button { background: #1a1a4d; color: orange; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
    button:hover { background: #29296b; }
  </style>
</head>
<body>
<div class="container">
  <div class="header-row">
    <div class="logo-box">লোগো</div>
    <h2>মেসার্স শামীম মটরস</h2>
    <div class="search-box">
      <div class="form-title">Sell Form</div>
      <div class="search-label" onclick="searchEntry()">সার্চ</div>
      <input type="text" id="searchInput">
    </div>
  </div>

  <form id="entryForm">
    <div class="form-row">
      <div class="form-group"><label>ক্রমিক নং:</label><input type="text" name="serial"></div>
      <div class="form-group"><label>তারিখ:</label><input type="date" name="date"></div>
    </div>

    <div class="form-row">
      <div class="form-group"><label>নাম:</label><input type="text" name="name"></div>
      <div class="form-group"><label>পিতার নাম:</label><input type="text" name="father"></div>
    </div>

    <div class="form-row">
      <div class="form-group"><label>এন.আই.ডি নং:</label><input type="text" name="nid"></div>
      <div class="form-group"><label>জন্ম তারিখ:</label><input type="date" name="dob"></div>
      <div class="form-group"><label>মোবাইল নম্বর:</label><input type="text" name="mobile"></div>
    </div>

    <div class="form-row">
      <div class="form-group"><label>ঠিকানা:</label><input type="text" name="address"></div>
    </div>

    <div class="section-title">বিবরণ</div>

    <div class="form-row">
      <div class="form-group"><label>গাড়ির ধরন:</label><input type="text" name="vehicle_type"></div>
      <div class="form-group"><label>নাম্বার প্লেট:</label><input type="text" name="number_plate"></div>
      <div class="form-group"><label>ইঞ্জিন নম্বর:</label><input type="text" name="engine"></div>
    </div>

    <div class="form-row">
      <div class="form-group"><label>চেসিস নম্বর:</label><input type="text" name="chassis"></div>
      <div class="form-group"><label>মডেল:</label><input type="text" name="model"></div>
    </div>

    <div class="form-row">
      <div class="form-group"><label>সিসি:</label><input type="text" name="cc"></div>
      <div class="form-group"><label>কালার:</label><input type="text" name="color"></div>
    </div>

    <div class="section-title">ক্যাশ</div>

    <div class="form-row">
      <div class="form-group"><label>মোট টাকা:</label><input type="text" name="total"></div>
      <div class="form-group"><label>নগদ টাকা:</label><input type="text" name="cash"></div>
      <div class="form-group"><label>বাকি টাকা:</label><input type="text" name="due"></div>
    </div>

    <div class="buttons">
      <button type="submit">জমা</button>
      <button type="button" onclick="loadPreviousEntry()">পূর্বের তথ্য</button>
      <button type="button" onclick="loadNextEntry()">পরের তথ্য</button>
      <button type="button" onclick="deleteEntry()">ডিলিট</button>
      <button type="button" onclick="downloadPDF()">PDF</button>
      <button type="button" onclick="printEntry()">প্রিন্ট</button>
      <button type="button" onclick="exportData()">এক্সপোর্ট</button>
    </div>
  </form>
</div>

<script>
  // ১) আপনার Apps Script Web App URL
  const apiURL = '/api';

  // ২) ক্লায়েন্ট-সাইড ডাটা হোল্ডার
  let allEntries = [];
  let currentIndex = -1;

  // ৩) পেজ লোডেই সব এন্ট্রি আনবো
  window.onload = fetchAllEntries;

  // ৪) ফর্ম সাবমিশন হ্যান্ডলার
  document.getElementById('entryForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const payload = {};
    formData.forEach((v, k) => payload[k] = v);

    fetch(apiURL, {
      method: 'doPOST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(result => {
      if (result.status === 'success') {
        alert('✅ সফলভাবে জমা হয়েছে!');
        form.reset();
        fetchAllEntries();
        currentIndex = -1;
      } else {
        alert('❌ জমা হয়নি!');
      }
    })
    .catch(err => {
      console.error('জমাতে সমস্যা হয়েছে ❌', err);
      alert('❌ জমাতে সমস্যা হয়েছে!');
    });
  });

  // ৫) সব এন্ট্রি আনা (GET with no params)
  function fetchAllEntries() {
    fetch(apiURL)
      .then(r => r.json())
      .then(data => {
        allEntries = data.entries || [];
        currentIndex = -1;
      })
      .catch(err => {
        console.error('ডেটা আনতে সমস্যা হয়েছে ❌', err);
      });
  }

  // ৬) ফরমে ডেটা ভর্তি করার হেলপার
  function fillForm(entry) {
    Object.keys(entry).forEach(key => {
      const fld = document.querySelector(`[name="${key}"]`);
      if (fld) fld.value = entry[key];
    });
  }

  // ৭) সার্চ (লোকাল কপি allEntries-এ)
  function searchEntry() {
    const q = document.getElementById('searchInput').value.trim().toLowerCase();
    if (!q) return alert('দয়া করে সার্চ টেক্সট দিন!');
    const idx = allEntries.findIndex(entry =>
      Object.values(entry).some(v =>
        String(v).toLowerCase().includes(q)
      )
    );
    if (idx !== -1) {
      currentIndex = idx;
      fillForm(allEntries[idx]);
      alert('✅ তথ্য পাওয়া গেছে!');
    } else {
      alert('❌ তথ্য খুঁজে পাওয়া যায়নি!');
    }
  }

  // ৮) 前/পরের এন্ট্রি লোড
  function loadPreviousEntry() {
    if (currentIndex > 0) {
      currentIndex--;
      fillForm(allEntries[currentIndex]);
    } else {
      alert('❌ প্রথম এন্ট্রিতে আছেন!');
    }
  }
  function loadNextEntry() {
    if (currentIndex < allEntries.length - 1) {
      currentIndex++;
      fillForm(allEntries[currentIndex]);
    } else {
      alert('❌ শেষ এন্ট্রিতে আছেন!');
    }
  }

  // ৯) লোকালি ডিলেট (Google Sheet থেকে আলাদা API দরকার)
  function deleteEntry() {
    if (currentIndex < 0) return alert('⚠️ কোন তথ্য সিলেক্ট করা হয়নি!');
    if (!confirm('আপনি কি ডিলেট করতে চান?')) return;
    allEntries.splice(currentIndex, 1);
    alert('✅ তথ্য লোকালি মুছে দেওয়া হয়েছে!');
    document.getElementById('entryForm').reset();
    currentIndex = -1;
  }

  // ১০) PDF/Print (print-form.html পেজে JSON পাঠিয়ে)
  function downloadPDF() {
    const data = Object.fromEntries(new FormData(document.getElementById('entryForm')));
    const qs   = encodeURIComponent(JSON.stringify(data));
    const url  = `print-form.html?data=${qs}`;
    const w    = window.open(url, '_blank');
    w.onload = () => w.print();
  }
  function printEntry() {
    const data = Object.fromEntries(new FormData(document.getElementById('entryForm')));
    const qs   = encodeURIComponent(JSON.stringify(data));
    window.open(`print-form.html?data=${qs}`, '_blank');
  }

  // ১১) এক্সপোর্ট CSV
  function exportData() {
    if (!allEntries.length) return alert('⚠️ কোন ডেটা নেই এক্সপোর্ট করার জন্য!');
    const headers = Object.keys(allEntries[0]);
    const rows    = allEntries.map(row =>
      headers.map(h => `"${row[h]||''}"`).join(',')
    );
    const csv = [headers.join(','), ...rows].join('\n');
    const blob= new Blob([csv], { type: 'text/csv' });
    const link= document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'entries.csv';
    link.click();
  }
</script>

<script>
    const totalInput = document.querySelector('input[name="total"]');
    const cashInput = document.querySelector('input[name="cash"]');
    const dueInput = document.querySelector('input[name="due"]');

    function calculateDue() {
      const total = parseFloat(totalInput.value) || 0;
      const cash = parseFloat(cashInput.value) || 0;
      const due = total - cash;
      dueInput.value = due >= 0 ? due : 0;
    }

    totalInput.addEventListener('input', calculateDue);
    cashInput.addEventListener('input', calculateDue);
  </script>

</body>
</html>
